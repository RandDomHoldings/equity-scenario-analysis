<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Equity Grant Calculator</title>
<style>
  :root {
    --bg: #0f1117;
    --surface: #1a1d27;
    --surface2: #242736;
    --border: #2e3142;
    --text: #e2e4eb;
    --text-muted: #8b8fa3;
    --accent: #6c5ce7;
    --accent-light: #a29bfe;
    --green: #00b894;
    --green-bg: rgba(0,184,148,0.08);
    --red: #e17055;
    --red-bg: rgba(225,112,85,0.08);
    --yellow: #fdcb6e;
    --yellow-bg: rgba(253,203,110,0.08);
    --blue: #74b9ff;
    --blue-bg: rgba(116,185,255,0.08);
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background: var(--bg);
    color: var(--text);
    line-height: 1.6;
    min-height: 100vh;
  }

  .container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 24px;
  }

  header {
    text-align: center;
    margin-bottom: 32px;
    padding-bottom: 24px;
    border-bottom: 1px solid var(--border);
  }

  header h1 {
    font-size: 24px;
    font-weight: 700;
    margin-bottom: 0;
  }

  header p {
    color: var(--text-muted);
    font-size: 14px;
  }

  .grid-2 {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
  }

  .grid-3 {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap: 20px;
  }

  .card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 20px;
  }

  .card h2 {
    font-size: 13px;
    text-transform: uppercase;
    letter-spacing: 0.8px;
    color: var(--text-muted);
    margin-bottom: 16px;
  }

  .field {
    margin-bottom: 14px;
  }

  .field:last-child { margin-bottom: 0; }

  .field label {
    display: block;
    font-size: 12px;
    color: var(--text-muted);
    margin-bottom: 4px;
  }

  .field-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .field-row .value {
    font-size: 15px;
    font-weight: 600;
    font-variant-numeric: tabular-nums;
  }

  select, input[type="number"] {
    width: 100%;
    background: var(--surface2);
    border: 1px solid var(--border);
    color: var(--text);
    padding: 8px 12px;
    border-radius: 8px;
    font-size: 14px;
    outline: none;
    transition: border-color 0.15s;
  }

  select:focus, input[type="number"]:focus {
    border-color: var(--accent);
  }

  input[type="number"]::-webkit-inner-spin-button { opacity: 0.5; }

  /* Toggle group */
  .toggle-group {
    display: flex;
    gap: 0;
    border-radius: 8px;
    overflow: hidden;
    border: 1px solid var(--border);
  }

  .toggle-group button {
    flex: 1;
    background: var(--surface2);
    border: none;
    color: var(--text-muted);
    padding: 8px 12px;
    font-size: 12px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.15s;
    border-right: 1px solid var(--border);
  }

  .toggle-group button:last-child { border-right: none; }

  .toggle-group button.active {
    background: var(--accent);
    color: #fff;
  }

  .toggle-group button:hover:not(.active) {
    background: var(--border);
    color: var(--text);
  }

  .kpi-grid {
    display: grid;
    grid-template-columns: repeat(5, 1fr);
    gap: 16px;
    margin: 24px 0;
  }

  .kpi {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 16px;
    text-align: center;
  }

  .kpi .label {
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: 0.6px;
    color: var(--text-muted);
    margin-bottom: 6px;
  }

  .kpi .number {
    font-size: 22px;
    font-weight: 700;
    font-variant-numeric: tabular-nums;
  }

  .kpi .sub {
    font-size: 11px;
    color: var(--text-muted);
    margin-top: 2px;
  }

  .positive { color: var(--green); }
  .negative { color: var(--red); }
  .neutral { color: var(--yellow); }

  .section-title {
    font-size: 16px;
    font-weight: 700;
    margin: 32px 0 16px;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .section-title .badge {
    font-size: 11px;
    background: var(--accent);
    color: #fff;
    padding: 2px 8px;
    border-radius: 4px;
    font-weight: 600;
  }

  /* Sensitivity Table */
  .table-wrapper {
    overflow-x: auto;
    border-radius: 12px;
    border: 1px solid var(--border);
    background: var(--surface);
  }

  table {
    width: 100%;
    border-collapse: collapse;
    font-size: 13px;
    font-variant-numeric: tabular-nums;
  }

  thead th {
    background: var(--surface2);
    padding: 10px 14px;
    text-align: right;
    font-weight: 600;
    font-size: 12px;
    color: var(--text-muted);
    position: sticky;
    top: 0;
    white-space: nowrap;
  }

  thead th:first-child {
    text-align: left;
    border-right: 2px solid var(--border);
  }

  tbody td {
    padding: 8px 14px;
    text-align: right;
    border-top: 1px solid var(--border);
    white-space: nowrap;
  }

  tbody td:first-child {
    text-align: left;
    font-weight: 600;
    color: var(--text-muted);
    border-right: 2px solid var(--border);
    background: var(--surface);
  }

  tbody tr:hover td {
    background: var(--surface2);
  }

  tbody tr:hover td:first-child {
    background: var(--surface2);
  }

  .highlight-cell {
    background: rgba(108, 92, 231, 0.15) !important;
    color: var(--accent-light);
    font-weight: 700;
  }

  .highlight-row td {
    background: rgba(108, 92, 231, 0.06) !important;
  }

  /* Dilution Waterfall */
  .waterfall {
    display: flex;
    align-items: flex-end;
    gap: 4px;
    height: 180px;
    margin: 16px 0;
    padding: 0 8px;
  }

  .waterfall-bar-group {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    height: 100%;
    justify-content: flex-end;
    position: relative;
  }

  .waterfall-bar {
    width: 100%;
    border-radius: 4px 4px 0 0;
    transition: height 0.3s ease;
    min-width: 0;
    position: relative;
  }

  .waterfall-bar-group .tip {
    font-size: 10px;
    font-weight: 600;
    white-space: nowrap;
    margin-bottom: 4px;
  }

  .waterfall-bar-group .bar-label {
    font-size: 9px;
    color: var(--text-muted);
    white-space: nowrap;
    margin-top: 6px;
    text-align: center;
  }

  .waterfall-bar-group .dilution-label {
    font-size: 9px;
    color: var(--red);
    white-space: nowrap;
    margin-top: 2px;
  }

  .info-note {
    background: var(--surface2);
    border-left: 3px solid var(--accent);
    padding: 12px 16px;
    border-radius: 0 8px 8px 0;
    font-size: 12px;
    color: var(--text-muted);
    margin-top: 20px;
    line-height: 1.7;
  }

  .tag {
    display: inline-block;
    font-size: 11px;
    padding: 2px 8px;
    border-radius: 4px;
    font-weight: 600;
  }

  .tag-green { background: var(--green-bg); color: var(--green); }
  .tag-red { background: var(--red-bg); color: var(--red); }
  .tag-yellow { background: var(--yellow-bg); color: var(--yellow); }
  .tag-blue { background: var(--blue-bg); color: var(--blue); }

  .carta-ref {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    font-size: 10px;
    color: var(--text-muted);
    background: var(--surface2);
    padding: 2px 6px;
    border-radius: 4px;
    margin-left: 4px;
  }

  .dilution-detail {
    display: grid;
    grid-template-columns: auto 1fr auto auto;
    gap: 4px 12px;
    font-size: 12px;
    margin-top: 12px;
    padding-top: 12px;
    border-top: 1px solid var(--border);
  }

  .dilution-detail .round-name { font-weight: 600; }
  .dilution-detail .bar-track {
    height: 6px;
    background: var(--surface2);
    border-radius: 3px;
    align-self: center;
    overflow: hidden;
  }
  .dilution-detail .bar-fill {
    height: 100%;
    border-radius: 3px;
    transition: width 0.3s;
  }

  /* Probability Table */
  .prob-table {
    font-size: 12px;
  }

  .prob-table thead th {
    padding: 8px 10px;
    font-size: 11px;
  }

  .prob-table tbody td {
    padding: 6px 10px;
  }

  .prob-table select.prob-input {
    width: 72px;
    text-align: right;
    padding: 5px 6px;
    font-size: 12px;
    font-variant-numeric: tabular-nums;
    background: var(--surface2);
    border: 1px solid var(--border);
    color: var(--green);
    border-radius: 6px;
    font-weight: 600;
  }

  .prob-table select.prob-input:focus {
    border-color: var(--accent);
    outline: none;
  }

  .prob-table tfoot td {
    font-weight: 700;
    border-top: 2px solid var(--border);
    padding: 8px 10px;
  }

  .prob-total-ok { color: var(--green); }
  .prob-total-err { color: var(--red); }


  /* Probability + Sensitivity Side-by-Side Layout */
  .prob-sens-layout {
    display: flex;
    gap: 20px;
    align-items: stretch;
    margin-top: 32px;
  }

  .prob-sens-panel {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 20px;
    display: flex;
    flex-direction: column;
  }

  .prob-sens-panel:first-child {
    flex: 0 0 340px;
    min-width: 0;
  }

  .prob-sens-panel:last-child {
    flex: 1;
    min-width: 0;
  }

  .prob-sens-panel .panel-title {
    font-size: 14px;
    font-weight: 700;
    margin-bottom: 4px;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .prob-sens-panel .panel-sub {
    font-size: 11px;
    color: var(--text-muted);
    margin-bottom: 14px;
    line-height: 1.4;
  }

  .prob-sens-panel .table-wrapper {
    border: none;
    background: transparent;
    border-radius: 0;
  }

  .prob-sens-panel .table-wrapper table thead th {
    background: var(--bg);
  }



  @media (max-width: 1100px) {
    .prob-sens-layout { flex-direction: column; }
    .prob-sens-panel:first-child {
      flex: none;
      width: 100%;
    }
  }

  @media (max-width: 900px) {
    .grid-2, .grid-3 { grid-template-columns: 1fr; }
    .kpi-grid { grid-template-columns: repeat(3, 1fr); }
  }
</style>
</head>
<body>
<div class="container">
  <header>
    <h1>New Hire Equity Grant Calculator</h1>
  </header>

  <!-- Input Section -->
  <div class="grid-3">
    <!-- Company Fundamentals -->
    <div class="card">
      <h2>Company Fundamentals</h2>
      <div class="field">
        <label>Shares Outstanding (Pre-Series B)</label>
        <div class="field-row">
          <span class="value">34,000,000</span>
        </div>
      </div>
      <div class="field">
        <label>Strike Price</label>
        <div class="field-row">
          <span class="value">$1.00</span>
        </div>
      </div>
      <div class="field">
        <label>Series B Terms</label>
        <div class="field-row">
          <span class="value" style="font-size:13px;">$200M raise &middot; $1.0B pre &middot; $1.2B post</span>
        </div>
      </div>
      <div class="field">
        <label>Series B New Shares Issued</label>
        <div class="field-row">
          <span class="value" id="seriesBShares">&mdash;</span>
        </div>
      </div>
      <div class="field">
        <label>Post-Series B Total Shares</label>
        <div class="field-row">
          <span class="value" id="postBTotalShares">&mdash;</span>
        </div>
      </div>
      <div class="field">
        <label>Implied Price Per Share (Preferred)</label>
        <div class="field-row">
          <span class="value" id="impliedPPS">&mdash;</span>
        </div>
      </div>
    </div>

    <!-- Grant Details -->
    <div class="card">
      <h2>Grant Details</h2>
      <div class="field">
        <label>Shares Granted (Common Stock)</label>
        <select id="sharesGranted">
          <option value="100000" selected>100,000</option>
          <option value="110000">110,000</option>
          <option value="120000">120,000</option>
          <option value="130000">130,000</option>
        </select>
      </div>
      <div class="field">
        <label>Ownership % at Grant (Pre-Series B)</label>
        <div class="field-row">
          <span class="value" id="ownershipAtGrant">&mdash;</span>
          <span class="tag tag-blue" style="font-size:10px;">Pre-dilution</span>
        </div>
      </div>
      <div class="field">
        <label>Ownership % Post-Series B</label>
        <div class="field-row">
          <span class="value" id="ownershipPostB">&mdash;</span>
        </div>
      </div>
      <div class="field">
        <label>Ownership % Fully Diluted (Post Series B&ndash;D)</label>
        <div class="field-row">
          <span class="value negative" id="ownershipFullyDiluted">&mdash;</span>
        </div>
      </div>
      <div class="field">
        <label>Paper Value at Series B PPS</label>
        <div class="field-row">
          <span class="value positive" id="paperValue">&mdash;</span>
          <span class="tag tag-yellow" style="font-size:10px;">Common &ne; Preferred</span>
        </div>
      </div>
    </div>

    <!-- Scenario Controls -->
    <div class="card">
      <h2>Scenario Controls</h2>
      <div class="field">
        <label>Series B Dilution <span class="carta-ref">Carta 50th pct: 16.0%</span></label>
        <select id="seriesBDilution">
          <option value="0.167">16.7% &mdash; Implied ($200M / $1.2B post)</option>
          <option value="0.10">10.0% &mdash; Carta 25th pct</option>
          <option value="0.16" selected>16.0% &mdash; Carta 50th pct</option>
          <option value="0.243">24.3% &mdash; Carta 75th pct</option>
        </select>
      </div>
      <div class="field">
        <label>Future Rounds (Post Series B)</label>
        <select id="futureRounds">
          <option value="0">None &mdash; Exit at Series B stage</option>
          <option value="1">Series C only</option>
          <option value="2" selected>Series C + D</option>
        </select>
      </div>
      <div class="field">
        <label>Dilution Severity
          <span class="carta-ref" id="severitySource">Carta deep tech data</span>
        </label>
        <div class="toggle-group" id="severityToggle">
          <button data-val="low">Low (25th pct)</button>
          <button data-val="mid" class="active">Mid (50th pct)</button>
          <button data-val="high">High (75th pct)</button>
        </div>
      </div>
      <div class="field">
        <label>Exit Valuation</label>
        <select id="exitValuation">
          <option value="1e9">$1B</option>
          <option value="2e9">$2B</option>
          <option value="3e9" selected>$3B</option>
          <option value="5e9">$5B</option>
          <option value="7e9">$7B</option>
          <option value="10e9">$10B</option>
          <option value="15e9">$15B</option>
          <option value="20e9">$20B</option>
        </select>
      </div>
      <div class="field">
        <label>Cumulative Dilution (All Rounds)</label>
        <div class="field-row">
          <span class="value negative" id="cumDilution">&mdash;</span>
        </div>
      </div>
    </div>
  </div>

  <!-- KPI Cards -->
  <div class="kpi-grid">
    <div class="kpi">
      <div class="label">Shares Granted</div>
      <div class="number" id="kpiShares">&mdash;</div>
      <div class="sub">Fixed at grant</div>
    </div>
    <div class="kpi">
      <div class="label">Total Shares at Exit</div>
      <div class="number" id="kpiTotalShares">&mdash;</div>
      <div class="sub" id="kpiTotalSharesSub">&mdash;</div>
    </div>
    <div class="kpi">
      <div class="label">Diluted Ownership at Exit</div>
      <div class="number" id="kpiOwnership">&mdash;</div>
      <div class="sub" id="kpiOwnershipSub">&mdash;</div>
    </div>
    <div class="kpi">
      <div class="label">Avg Annual Comp</div>
      <div class="number positive" id="kpiAvgAnnual">&mdash;</div>
      <div class="sub" id="kpiAvgAnnualSub">Cash + equity / 4 years</div>
    </div>
    <div class="kpi">
      <div class="label">Total 4-Year Comp</div>
      <div class="number positive" id="kpiTotal4yr">&mdash;</div>
      <div class="sub" id="kpiTotal4yrSub">Cash + net equity value</div>
    </div>
  </div>

  <!-- Dilution Waterfall -->
  <div class="section-title">Dilution Waterfall <span class="badge">Ownership %</span></div>
  <div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
      <span style="font-size:12px;color:var(--text-muted);">Ownership % as total shares outstanding increase each round</span>
      <span id="waterfallTotal" class="tag tag-red" style="font-size:12px;"></span>
    </div>
    <div class="waterfall" id="waterfall"></div>
    <div style="height:24px;"></div>
    <div class="dilution-detail" id="dilutionDetail"></div>
  </div>

  <!-- Probability-Weighted Outcomes + Sensitivity Table -->
  <div class="prob-sens-layout">
    <div class="prob-sens-panel">
      <div class="panel-title">Probability-Weighted Outcomes <span class="badge">Expected Value</span></div>
      <p class="panel-sub">Assign probability weights to exit scenarios. Weighted EV drives the highlighted column &rarr;</p>
      <div class="table-wrapper">
        <table id="probTable" class="prob-table"></table>
      </div>
    </div>
    <div class="prob-sens-panel">
      <div class="panel-title">Annualized Net Equity Value Post-Dilution <span class="badge">Shares &times; Exit</span></div>
      <p class="panel-sub">(Shares &times; exit valuation &divide; fully diluted shares &minus; strike cost) &divide; 4 years</p>
      <div class="table-wrapper">
        <table id="sensitivityTable"></table>
      </div>
    </div>
  </div>

  <div class="info-note">
    <strong>Assumptions & Disclaimers:</strong><br>
    &bull; <strong>Dilution model:</strong> Granted shares are fixed. Dilution occurs as new shares are issued to investors each round, increasing total shares outstanding and reducing ownership percentage.<br>
    &bull; <strong>Series B dilution:</strong> The $200M raise at $1.0B pre-money implies ~16.7% dilution ($200M/$1.2B). The default uses the Carta median of 16.0% for Series B rounds.<br>
    &bull; <strong>Carta benchmarks:</strong> Future round dilution uses Carta's deep tech fundraising data (919 rounds). Series C: 8.5% / 14.0% / 21.0% at 25th/50th/75th percentile. Series D+ estimated from priced round trends.<br>
    &bull; <strong>Common vs. Preferred:</strong> This grant is common stock valued at the preferred PPS for illustration. Common shares typically trade at a discount to preferred due to lack of liquidation preferences and other protective provisions. The $1.00 strike price reflects a 409A valuation, not the preferred price.<br>
    &bull; <strong>Strike cost:</strong> Exercise cost is $1.00 &times; shares. Net value = (shares granted &divide; total shares &times; exit valuation) &minus; strike cost.<br>
    &bull; This is not financial or tax advice. AMT, capital gains, and liquidity preferences are not modeled.
  </div>


</div>

<script>
  // =====================================================
  // CONSTANTS
  // =====================================================
  const PRE_B_SHARES = 34_000_000;
  const SERIES_B_RAISE = 200_000_000;
  const PRE_MONEY = 1_000_000_000;
  const POST_MONEY = PRE_MONEY + SERIES_B_RAISE;
  const STRIKE_PRICE = 1.00;

  // Series B: new shares = pre-B shares * (raise / pre-money)
  const SERIES_B_NEW_SHARES = PRE_B_SHARES * (SERIES_B_RAISE / PRE_MONEY);
  const POST_B_TOTAL_SHARES = PRE_B_SHARES + SERIES_B_NEW_SHARES;
  const IMPLIED_PPS = POST_MONEY / POST_B_TOTAL_SHARES;

  // =====================================================
  // CARTA DILUTION BENCHMARKS (Deep Tech, Priced Rounds)
  // Source: 919 rounds from US deep tech startups on Carta
  // =====================================================
  // { low: 25th pct, mid: 50th pct, high: 75th pct }
  const CARTA_DILUTION = {
    seriesB: { low: 0.100, mid: 0.160, high: 0.243 },
    seriesC: { low: 0.085, mid: 0.140, high: 0.210 },
    // Series D+ &mdash; extrapolated from Carta priced round trends
    // Later rounds typically have lower dilution as companies are larger
    seriesD: { low: 0.060, mid: 0.100, high: 0.160 },
  };

  // =====================================================
  // HELPERS
  // =====================================================
  function fmt(n, decimals = 0) {
    return n.toLocaleString('en-US', { minimumFractionDigits: decimals, maximumFractionDigits: decimals });
  }
  function fmtDollar(n, decimals = 0) {
    const abs = Math.abs(n);
    const sign = n < 0 ? '-' : '';
    if (abs >= 1e9) return sign + '$' + (abs / 1e9).toFixed(1) + 'B';
    if (abs >= 1e6) return sign + '$' + (abs / 1e6).toFixed(1) + 'M';
    if (abs >= 1e3) return sign + '$' + (abs / 1e3).toFixed(0) + 'K';
    return sign + '$' + fmt(abs, decimals);
  }
  function fmtPct(n, decimals = 4) {
    return (n * 100).toFixed(decimals) + '%';
  }
  function fmtMoney(n) {
    if (n < 0) return '-$' + fmt(Math.abs(n));
    return '$' + fmt(n);
  }

  // =====================================================
  // DOM REFS
  // =====================================================
  const elSharesGranted = document.getElementById('sharesGranted');
  const elSeriesBDilution = document.getElementById('seriesBDilution');
  const elFutureRounds = document.getElementById('futureRounds');
  const elExitValuation = document.getElementById('exitValuation');

  let severity = 'mid'; // low, mid, high

  // Severity toggle
  document.querySelectorAll('#severityToggle button').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('#severityToggle button').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      severity = btn.dataset.val;
      compute();
    });
  });

  // =====================================================
  // CORE COMPUTATION
  // =====================================================
  function getDilutionSchedule() {
    const seriesBDilution = parseFloat(elSeriesBDilution.value);
    const futureRounds = parseInt(elFutureRounds.value);

    // Build round-by-round schedule
    // Each entry: { name, dilutionPct, newSharesIssued, totalSharesAfter }
    const schedule = [];

    // Series B &mdash; uses the dropdown (could be implied or Carta)
    const seriesBNewShares = (PRE_B_SHARES / (1 - seriesBDilution)) - PRE_B_SHARES;
    let totalShares = PRE_B_SHARES + seriesBNewShares;
    schedule.push({
      name: 'Series B',
      dilutionPct: seriesBDilution,
      newSharesIssued: seriesBNewShares,
      totalSharesAfter: totalShares,
    });

    // Future rounds use Carta benchmarks based on severity toggle
    const roundDefs = [
      { name: 'Series C', data: CARTA_DILUTION.seriesC },
      { name: 'Series D', data: CARTA_DILUTION.seriesD },
    ];

    for (let i = 0; i < futureRounds && i < roundDefs.length; i++) {
      const dilPct = roundDefs[i].data[severity];
      const newShares = (totalShares / (1 - dilPct)) - totalShares;
      totalShares += newShares;
      schedule.push({
        name: roundDefs[i].name,
        dilutionPct: dilPct,
        newSharesIssued: newShares,
        totalSharesAfter: totalShares,
      });
    }

    return schedule;
  }

  function compute() {
    const sharesGranted = parseInt(elSharesGranted.value) || 0;
    const schedule = getDilutionSchedule();

    // --- Fundamentals ---
    document.getElementById('seriesBShares').textContent = fmt(Math.round(SERIES_B_NEW_SHARES));
    document.getElementById('postBTotalShares').textContent = fmt(Math.round(POST_B_TOTAL_SHARES));
    document.getElementById('impliedPPS').textContent = '$' + IMPLIED_PPS.toFixed(2);

    // --- Ownership at various stages ---
    const ownershipAtGrant = sharesGranted / PRE_B_SHARES;
    document.getElementById('ownershipAtGrant').textContent = fmtPct(ownershipAtGrant);

    const totalSharesAfterB = schedule[0].totalSharesAfter;
    const ownershipPostB = sharesGranted / totalSharesAfterB;
    document.getElementById('ownershipPostB').textContent = fmtPct(ownershipPostB);

    const finalTotalShares = schedule[schedule.length - 1].totalSharesAfter;
    const ownershipFinal = sharesGranted / finalTotalShares;
    document.getElementById('ownershipFullyDiluted').textContent = fmtPct(ownershipFinal);

    // Paper value
    const paperValue = sharesGranted * IMPLIED_PPS - sharesGranted * STRIKE_PRICE;
    document.getElementById('paperValue').textContent = fmtMoney(Math.round(paperValue));

    // Cumulative dilution from grant
    const cumDilution = 1 - (ownershipFinal / ownershipAtGrant);
    document.getElementById('cumDilution').textContent = fmtPct(cumDilution, 1);

    // --- KPIs ---
    document.getElementById('kpiShares').textContent = fmt(sharesGranted);

    document.getElementById('kpiTotalShares').textContent = fmt(Math.round(finalTotalShares));
    document.getElementById('kpiTotalSharesSub').textContent = 'from ' + fmt(PRE_B_SHARES) + ' pre-B';

    document.getElementById('kpiOwnership').textContent = fmtPct(ownershipFinal);
    document.getElementById('kpiOwnershipSub').textContent = fmtPct(ownershipAtGrant) + ' at grant';

    // --- Waterfall ---
    buildWaterfall(sharesGranted, schedule);

    // --- Sensitivity Table ---
    buildSensitivityTable(sharesGranted, finalTotalShares);

    // --- Probability Table ---
    buildProbTable(sharesGranted, finalTotalShares);

    // --- Avg Annual & Total 4-Year KPIs ---
    const exitValuation = parseFloat(elExitValuation.value);
    const exitPPS = exitValuation / finalTotalShares;
    const netEquity = sharesGranted * exitPPS - sharesGranted * STRIKE_PRICE;
    const total4yr = CASH_COMP * HORIZON + netEquity;
    const avgAnnual = total4yr / HORIZON;
    document.getElementById('kpiAvgAnnual').textContent = fmtDollar(avgAnnual);
    document.getElementById('kpiAvgAnnualSub').textContent = 'Cash + equity at ' + fmtDollar(exitValuation) + ' exit';
    document.getElementById('kpiTotal4yr').textContent = fmtDollar(total4yr);
    document.getElementById('kpiTotal4yrSub').textContent = fmtDollar(CASH_COMP * HORIZON) + ' cash + ' + fmtDollar(netEquity) + ' equity';
  }

  // =====================================================
  // WATERFALL
  // =====================================================
  function buildWaterfall(sharesGranted, schedule) {
    const container = document.getElementById('waterfall');
    container.innerHTML = '';

    // Build stages: At Grant, then after each round
    const stages = [];
    stages.push({
      label: 'At Grant',
      ownership: sharesGranted / PRE_B_SHARES,
      totalShares: PRE_B_SHARES,
      dilution: 0,
    });

    schedule.forEach(round => {
      stages.push({
        label: 'Post ' + round.name,
        ownership: sharesGranted / round.totalSharesAfter,
        totalShares: round.totalSharesAfter,
        dilution: round.dilutionPct,
      });
    });

    const maxPct = stages[0].ownership;
    const colors = ['#6c5ce7', '#a29bfe', '#74b9ff', '#81ecec', '#55efc4'];

    stages.forEach((s, i) => {
      const group = document.createElement('div');
      group.className = 'waterfall-bar-group';

      const heightPct = (s.ownership / maxPct) * 100;
      const color = colors[i % colors.length];

      group.innerHTML = `
        <span class="tip" style="color:${color}">${fmtPct(s.ownership, 4)}</span>
        <div class="waterfall-bar" style="height:${heightPct}%;background:${color};"></div>
        <span class="bar-label">${s.label}</span>
        ${s.dilution > 0 ? `<span class="dilution-label">-${fmtPct(s.dilution, 1)}</span>` : '<span class="dilution-label" style="color:var(--green);">Baseline</span>'}
      `;
      container.appendChild(group);
    });

    const totalDilution = 1 - (stages[stages.length - 1].ownership / stages[0].ownership);
    document.getElementById('waterfallTotal').textContent = 'Cumulative dilution: ' + fmtPct(totalDilution, 1);

    // Detail rows
    const detail = document.getElementById('dilutionDetail');
    let detailHtml = '';
    schedule.forEach((round, i) => {
      const pctWidth = (round.dilutionPct / 0.30) * 100; // normalize to 30% max
      const color = round.dilutionPct > 0.20 ? 'var(--red)' : round.dilutionPct > 0.12 ? 'var(--yellow)' : 'var(--green)';
      detailHtml += `
        <span class="round-name">${round.name}</span>
        <div class="bar-track"><div class="bar-fill" style="width:${Math.min(pctWidth, 100)}%;background:${color};"></div></div>
        <span style="color:${color};font-weight:600;">${fmtPct(round.dilutionPct, 1)}</span>
        <span style="color:var(--text-muted);">+${fmt(Math.round(round.newSharesIssued))} shares &rarr; ${fmt(Math.round(round.totalSharesAfter))} total</span>
      `;
    });
    detail.innerHTML = detailHtml;
  }

  // =====================================================
  // SENSITIVITY TABLE &mdash; POST-DILUTION NET VALUE
  // =====================================================
  function buildSensitivityTable(currentShares, finalTotalShares) {
    const table = document.getElementById('sensitivityTable');
    const shareValues = [100000, 110000, 120000, 130000];

    const exitValues = [];
    for (let e = 1e9; e <= 10e9; e += 1e9) exitValues.push(e);

    // Use weighted EV from probability table to determine highlighted column
    const { weightedEV } = getWeightedEV();
    let closestExitCol = exitValues[0];
    let closestDist = Math.abs(weightedEV - closestExitCol);
    exitValues.forEach(ev => {
      const dist = Math.abs(weightedEV - ev);
      if (dist < closestDist) { closestDist = dist; closestExitCol = ev; }
    });

    let html = '<thead><tr><th>Shares &darr; \\ Exit &rarr;</th>';
    exitValues.forEach(ev => {
      const isSelectedCol = ev === closestExitCol;
      html += `<th${isSelectedCol ? ' style="color:var(--accent-light);"' : ''}>${fmtDollar(ev)}</th>`;
    });
    html += '</tr></thead><tbody>';

    shareValues.forEach(shares => {
      const isCurrentRow = shares === currentShares;
      html += `<tr class="${isCurrentRow ? 'highlight-row' : ''}">`;
      html += `<td>${fmt(shares)}${isCurrentRow ? ' <span style="font-size:9px;color:var(--accent-light);">&laquo; SELECTED</span>' : ''}</td>`;
      exitValues.forEach(ev => {
        const pps = ev / finalTotalShares;
        const gross = shares * pps;
        const strikeCost = shares * STRIKE_PRICE;
        const net = gross - strikeCost;
        const annualized = net / HORIZON;
        const isHighlight = isCurrentRow && ev === closestExitCol;
        const cls = isHighlight ? 'highlight-cell' : '';
        const colorCls = annualized < 0 ? 'negative' : '';
        html += `<td class="${cls} ${colorCls}">${fmtDollar(annualized)}</td>`;
      });
      html += '</tr>';
    });

    html += '</tbody>';
    table.innerHTML = html;
  }

  const CASH_COMP = 300_000;     // annual cash compensation
  const HORIZON = 4;             // years

  // =====================================================
  // PROBABILITY-WEIGHTED OUTCOMES
  // =====================================================
  // Default scenarios matching user's spreadsheet
  const PROB_SCENARIOS = [
    { ev: 0,    prob: 10 },
    { ev: 1e9,  prob: 20 },
    { ev: 3e9,  prob: 50 },
    { ev: 10e9, prob: 15 },
    { ev: 25e9, prob: 5 },
  ];

  function getWeightedEV() {
    let totalProb = 0, weightedSum = 0;
    PROB_SCENARIOS.forEach(s => {
      totalProb += s.prob;
      weightedSum += s.ev * (s.prob / 100);
    });
    return { weightedEV: weightedSum, totalProb };
  }

  function buildProbTable(sharesGranted, finalTotalShares) {
    const table = document.getElementById('probTable');
    const { weightedEV, totalProb } = getWeightedEV();
    const probOk = Math.abs(totalProb - 100) < 0.01;

    let html = `<thead><tr>
      <th style="text-align:left;border-right:2px solid var(--border);">EV Scenario</th>
      <th>Probability</th>
      <th>Expected Value</th>
    </tr></thead><tbody>`;

    PROB_SCENARIOS.forEach((s, i) => {
      const expectedVal = s.ev * (s.prob / 100);

      // Build dropdown options in 5% increments (0-100)
      let options = '';
      for (let p = 0; p <= 100; p += 5) {
        options += `<option value="${p}"${p === s.prob ? ' selected' : ''}>${p}%</option>`;
      }

      html += `<tr>
        <td>${fmtDollar(s.ev)}</td>
        <td style="text-align:center;">
          <select data-prob-idx="${i}" class="prob-input">
            ${options}
          </select>
        </td>
        <td>${fmtDollar(expectedVal)}</td>
      </tr>`;
    });

    // Totals row with weighted EV and multiple
    const totalCls = probOk ? 'prob-total-ok' : 'prob-total-err';
    const evMultiple = (weightedEV / PRE_MONEY).toFixed(1) + '\u00D7';
    html += `</tbody><tfoot><tr>
      <td><strong>Weighted EV</strong></td>
      <td style="text-align:center;" class="${totalCls}"><strong>${totalProb.toFixed(0)}%</strong>${!probOk ? ' <span style="font-size:10px;">(must = 100%)</span>' : ''}</td>
      <td><strong>${fmtDollar(weightedEV)}</strong> <span style="color:var(--accent-light);font-size:11px;">(${evMultiple})</span></td>
    </tr></tfoot>`;

    table.innerHTML = html;

    // Bind select listeners
    table.querySelectorAll('.prob-input').forEach(sel => {
      sel.addEventListener('change', (e) => {
        const idx = parseInt(e.target.dataset.probIdx);
        PROB_SCENARIOS[idx].prob = parseFloat(e.target.value) || 0;
        compute();
      });
    });
  }

  // =====================================================
  // EVENT LISTENERS
  // =====================================================
  [elSharesGranted, elSeriesBDilution, elFutureRounds, elExitValuation].forEach(el => {
    el.addEventListener('change', compute);
    el.addEventListener('input', compute);
  });

  // Init
  compute();
</script>
</body>
</html>
