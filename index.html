<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Equity Scenario Analysis</title>
<style>
  :root {
    --bg: #0f1117;
    --surface: #1a1d27;
    --surface2: #242736;
    --border: #2e3142;
    --text: #e2e4eb;
    --text-muted: #8b8fa3;
    --accent: #6c5ce7;
    --accent-light: #a29bfe;
    --green: #00b894;
    --green-bg: rgba(0,184,148,0.08);
    --red: #e17055;
    --red-bg: rgba(225,112,85,0.08);
    --yellow: #fdcb6e;
    --yellow-bg: rgba(253,203,110,0.08);
    --blue: #74b9ff;
    --blue-bg: rgba(116,185,255,0.08);
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background: var(--bg);
    color: var(--text);
    line-height: 1.6;
    min-height: 100vh;
  }

  .container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 24px;
  }

  header {
    text-align: center;
    margin-bottom: 32px;
    padding-bottom: 24px;
    border-bottom: 1px solid var(--border);
  }

  header h1 {
    font-size: 24px;
    font-weight: 700;
    margin-bottom: 0;
  }

  header p {
    color: var(--text-muted);
    font-size: 14px;
  }

  .grid-2 {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
  }

  .grid-3 {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap: 20px;
  }

  .card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 20px;
  }

  .card h2 {
    font-size: 13px;
    text-transform: uppercase;
    letter-spacing: 0.8px;
    color: var(--text-muted);
    margin-bottom: 16px;
  }

  .field {
    margin-bottom: 14px;
  }

  .field:last-child { margin-bottom: 0; }

  .field label {
    display: block;
    font-size: 12px;
    color: var(--text-muted);
    margin-bottom: 4px;
  }

  .field-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .field-row .value {
    font-size: 15px;
    font-weight: 600;
    font-variant-numeric: tabular-nums;
  }

  select, input[type="number"] {
    width: 100%;
    background: var(--surface2);
    border: 1px solid var(--border);
    color: var(--text);
    padding: 8px 12px;
    border-radius: 8px;
    font-size: 14px;
    outline: none;
    transition: border-color 0.15s;
  }

  select:focus, input[type="number"]:focus {
    border-color: var(--accent);
  }

  input[type="number"]::-webkit-inner-spin-button { opacity: 0.5; }

  .kpi-grid {
    display: grid;
    grid-template-columns: repeat(5, 1fr);
    gap: 16px;
    margin: 24px 0;
  }

  .kpi {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 16px;
    text-align: center;
  }

  .kpi .label {
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: 0.6px;
    color: var(--text-muted);
    margin-bottom: 6px;
  }

  .kpi .number {
    font-size: 22px;
    font-weight: 700;
    font-variant-numeric: tabular-nums;
  }

  .kpi .sub {
    font-size: 11px;
    color: var(--text-muted);
    margin-top: 2px;
  }

  .positive { color: var(--green); }
  .negative { color: var(--red); }
  .neutral { color: var(--yellow); }

  .section-title {
    font-size: 16px;
    font-weight: 700;
    margin: 32px 0 16px;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .section-title .badge {
    font-size: 11px;
    background: var(--accent);
    color: #fff;
    padding: 2px 8px;
    border-radius: 4px;
    font-weight: 600;
  }

  /* Sensitivity Table */
  .table-wrapper {
    overflow-x: auto;
    border-radius: 12px;
    border: 1px solid var(--border);
    background: var(--surface);
  }

  table {
    width: 100%;
    border-collapse: collapse;
    font-size: 13px;
    font-variant-numeric: tabular-nums;
  }

  thead th {
    background: var(--surface2);
    padding: 10px 14px;
    text-align: right;
    font-weight: 600;
    font-size: 12px;
    color: var(--text-muted);
    position: sticky;
    top: 0;
    white-space: nowrap;
  }

  thead th:first-child {
    text-align: left;
    border-right: 2px solid var(--border);
  }

  tbody td {
    padding: 8px 14px;
    text-align: right;
    border-top: 1px solid var(--border);
    white-space: nowrap;
  }

  tbody td:first-child {
    text-align: left;
    font-weight: 600;
    color: var(--text-muted);
    border-right: 2px solid var(--border);
    background: var(--surface);
  }

  tbody tr:hover td {
    background: var(--surface2);
  }

  tbody tr:hover td:first-child {
    background: var(--surface2);
  }

  .highlight-cell {
    background: rgba(108, 92, 231, 0.15) !important;
    color: var(--accent-light);
    font-weight: 700;
  }

  .highlight-row td {
    background: rgba(108, 92, 231, 0.06) !important;
  }

  /* Dilution Waterfall */
  .waterfall {
    display: flex;
    align-items: flex-end;
    gap: 4px;
    height: 180px;
    margin: 16px 0;
    padding: 0 8px;
  }

  .waterfall-bar-group {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    height: 100%;
    justify-content: flex-end;
    position: relative;
  }

  .waterfall-bar {
    width: 100%;
    border-radius: 4px 4px 0 0;
    transition: height 0.3s ease;
    min-width: 0;
    position: relative;
  }

  .waterfall-bar-group .tip {
    font-size: 10px;
    font-weight: 600;
    white-space: nowrap;
    margin-bottom: 4px;
  }

  .waterfall-bar-group .bar-label {
    font-size: 9px;
    color: var(--text-muted);
    white-space: nowrap;
    margin-top: 6px;
    text-align: center;
  }

  .waterfall-bar-group .dilution-label {
    font-size: 9px;
    color: var(--red);
    white-space: nowrap;
    margin-top: 2px;
  }

  .info-note {
    background: var(--surface2);
    border-left: 3px solid var(--accent);
    padding: 12px 16px;
    border-radius: 0 8px 8px 0;
    font-size: 12px;
    color: var(--text-muted);
    margin-top: 20px;
    line-height: 1.7;
  }

  .tag {
    display: inline-block;
    font-size: 11px;
    padding: 2px 8px;
    border-radius: 4px;
    font-weight: 600;
  }

  .tag-green { background: var(--green-bg); color: var(--green); }
  .tag-red { background: var(--red-bg); color: var(--red); }
  .tag-yellow { background: var(--yellow-bg); color: var(--yellow); }
  .tag-blue { background: var(--blue-bg); color: var(--blue); }

  .carta-ref {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    font-size: 10px;
    color: var(--text-muted);
    background: var(--surface2);
    padding: 2px 6px;
    border-radius: 4px;
    margin-left: 4px;
  }

  .dilution-detail {
    display: grid;
    grid-template-columns: auto 1fr auto auto;
    gap: 4px 12px;
    font-size: 12px;
    margin-top: 12px;
    padding-top: 12px;
    border-top: 1px solid var(--border);
  }

  .dilution-detail .round-name { font-weight: 600; }
  .dilution-detail .bar-track {
    height: 6px;
    background: var(--surface2);
    border-radius: 3px;
    align-self: center;
    overflow: hidden;
  }
  .dilution-detail .bar-fill {
    height: 100%;
    border-radius: 3px;
    transition: width 0.3s;
  }

  @media (max-width: 900px) {
    .grid-2, .grid-3 { grid-template-columns: 1fr; }
    .kpi-grid { grid-template-columns: repeat(3, 1fr); }
  }
</style>
</head>
<body>
<div class="container">
  <header>
    <h1>Equity Scenario Analysis</h1>
  </header>

  <!-- Input Section -->
  <div class="grid-3">
    <!-- Company Fundamentals -->
    <div class="card">
      <h2>Company Fundamentals</h2>
      <div class="field">
        <label>Shares Outstanding (Pre-Series B)</label>
        <div class="field-row">
          <span class="value">34,000,000</span>
        </div>
      </div>
      <div class="field">
        <label>Strike Price</label>
        <div class="field-row">
          <span class="value">$1.00</span>
        </div>
      </div>
      <div class="field">
        <label>Series B Terms</label>
        <div class="field-row">
          <span class="value" style="font-size:13px;">$200M raise &middot; $1.0B pre &middot; $1.2B post</span>
        </div>
      </div>
      <div class="field">
        <label>Series B New Shares Issued</label>
        <div class="field-row">
          <span class="value" id="seriesBShares">&mdash;</span>
        </div>
      </div>
      <div class="field">
        <label>Post-Series B Total Shares</label>
        <div class="field-row">
          <span class="value" id="postBTotalShares">&mdash;</span>
        </div>
      </div>
      <div class="field">
        <label>Implied Price Per Share (Preferred)</label>
        <div class="field-row">
          <span class="value" id="impliedPPS">&mdash;</span>
        </div>
      </div>
    </div>

    <!-- Grant Details -->
    <div class="card">
      <h2>Grant Details</h2>
      <div class="field">
        <label>Shares Granted (Common Stock)</label>
        <div class="field-row">
          <span class="value">110,000</span>
        </div>
      </div>
      <div class="field">
        <label>Ownership % at Grant (Pre-Series B)</label>
        <div class="field-row">
          <span class="value" id="ownershipAtGrant">&mdash;</span>
          <span class="tag tag-blue" style="font-size:10px;">Pre-dilution</span>
        </div>
      </div>
      <div class="field">
        <label>Ownership % Post-Series B</label>
        <div class="field-row">
          <span class="value" id="ownershipPostB">&mdash;</span>
        </div>
      </div>
      <div class="field">
        <label>Ownership % Fully Diluted (Post Series B&ndash;D)</label>
        <div class="field-row">
          <span class="value negative" id="ownershipFullyDiluted">&mdash;</span>
        </div>
      </div>
      <div class="field">
        <label>Paper Value at Series B PPS</label>
        <div class="field-row">
          <span class="value positive" id="paperValue">&mdash;</span>
          <span class="tag tag-yellow" style="font-size:10px;">Common &ne; Preferred</span>
        </div>
      </div>
    </div>

    <!-- Scenario Controls -->
    <div class="card">
      <h2>Scenario Controls</h2>
      <div class="field">
        <label>Series B Dilution <span class="carta-ref">Carta 50th pct: 16.0%</span></label>
        <select id="seriesBDilution">
          <option value="0.167">16.7% &mdash; Implied ($200M / $1.2B post)</option>
          <option value="0.10">10.0% &mdash; Carta 25th pct</option>
          <option value="0.16" selected>16.0% &mdash; Carta 50th pct</option>
          <option value="0.243">24.3% &mdash; Carta 75th pct</option>
        </select>
      </div>
      <div class="field">
        <label>Future Rounds (Post Series B)</label>
        <select id="futureRounds">
          <option value="0">None &mdash; Exit at Series B stage</option>
          <option value="1">Series C only</option>
          <option value="2" selected>Series C + D</option>
        </select>
      </div>
      <div class="field">
        <label>Dilution Severity (Series C &amp; D)
          <span class="carta-ref">Carta deep tech data</span>
        </label>
        <select id="severitySelect">
          <option value="low">Low (25th pct)</option>
          <option value="mid">Mid (50th pct)</option>
          <option value="high" selected>High (75th pct)</option>
        </select>
      </div>
      <div class="field">
        <label>Cumulative Dilution (All Rounds)</label>
        <div class="field-row">
          <span class="value negative" id="cumDilution">&mdash;</span>
        </div>
      </div>
    </div>
  </div>

  <!-- KPI Cards -->
  <div class="kpi-grid">
    <div class="kpi">
      <div class="label">Shares Granted</div>
      <div class="number" id="kpiShares">&mdash;</div>
      <div class="sub">Fixed at grant</div>
    </div>
    <div class="kpi">
      <div class="label">Total Shares at Exit</div>
      <div class="number" id="kpiTotalShares">&mdash;</div>
      <div class="sub" id="kpiTotalSharesSub">&mdash;</div>
    </div>
    <div class="kpi">
      <div class="label">Diluted Ownership at Exit</div>
      <div class="number" id="kpiOwnership">&mdash;</div>
      <div class="sub" id="kpiOwnershipSub">&mdash;</div>
    </div>
    <div class="kpi">
      <div class="label">4-Year Equity Value (at 5&times;)</div>
      <div class="number positive" id="kpiEquity4yr">&mdash;</div>
      <div class="sub" id="kpiEquity4yrSub">Net equity at $5B exit</div>
    </div>
    <div class="kpi">
      <div class="label">Total 4-Year Comp (at 5&times;)</div>
      <div class="number positive" id="kpiTotal4yr">&mdash;</div>
      <div class="sub" id="kpiTotal4yrSub">Cash + net equity value</div>
    </div>
  </div>

  <!-- Dilution Waterfall -->
  <div class="section-title">Dilution Waterfall <span class="badge">Ownership %</span></div>
  <div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
      <span style="font-size:12px;color:var(--text-muted);">Ownership % as total shares outstanding increase each round</span>
      <span id="waterfallTotal" class="tag tag-red" style="font-size:12px;"></span>
    </div>
    <div class="waterfall" id="waterfall"></div>
    <div style="height:24px;"></div>
    <div class="dilution-detail" id="dilutionDetail"></div>
  </div>

  <!-- Net Equity Value Table -->
  <div class="section-title">Net Equity Value Over 4-Year Vest <span class="badge">110K Shares</span></div>
  <p style="font-size:12px;color:var(--text-muted);margin-bottom:8px;">(110K &times; exit valuation &divide; fully diluted shares &minus; strike cost) across exit scenarios up to $20B</p>
  <div class="table-wrapper">
    <table id="sensitivityTable"></table>
  </div>

  <!-- Equity Value Chart -->
  <div class="section-title">Equity Value by Exit &amp; Dilution <span class="badge">Visual</span></div>
  <div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
      <span style="font-size:12px;color:var(--text-muted);">Total 4-year net equity value (110K shares) across exit valuations and dilution severity</span>
    </div>
    <canvas id="equityChart" width="900" height="340" style="width:100%;height:auto;"></canvas>
    <div style="display:flex;gap:20px;justify-content:center;margin-top:12px;">
      <span style="font-size:11px;color:var(--green);"><span style="display:inline-block;width:24px;height:3px;background:var(--green);vertical-align:middle;margin-right:4px;border-radius:2px;"></span>Low dilution (25th pct)</span>
      <span style="font-size:11px;color:var(--accent-light);"><span style="display:inline-block;width:24px;height:3px;background:var(--accent-light);vertical-align:middle;margin-right:4px;border-radius:2px;"></span>Mid dilution (50th pct)</span>
      <span style="font-size:11px;color:var(--red);"><span style="display:inline-block;width:24px;height:3px;background:var(--red);vertical-align:middle;margin-right:4px;border-radius:2px;"></span>High dilution (75th pct)</span>
    </div>
  </div>

  <div class="info-note">
    <strong>Assumptions & Disclaimers:</strong><br>
    &bull; <strong>Dilution model:</strong> Granted shares are fixed. Dilution occurs as new shares are issued to investors each round, increasing total shares outstanding and reducing ownership percentage.<br>
    &bull; <strong>Series B dilution:</strong> The $200M raise at $1.0B pre-money implies ~16.7% dilution ($200M/$1.2B). The default uses the Carta median of 16.0% for Series B rounds.<br>
    &bull; <strong>Carta benchmarks:</strong> Future round dilution uses Carta's deep tech fundraising data (919 rounds). Series C: 8.5% / 14.0% / 21.0% at 25th/50th/75th percentile. Series D+ estimated from priced round trends.<br>
    &bull; <strong>Common vs. Preferred:</strong> This grant is common stock valued at the preferred PPS for illustration. Common shares typically trade at a discount to preferred due to lack of liquidation preferences and other protective provisions. The $1.00 strike price reflects a 409A valuation, not the preferred price.<br>
    &bull; <strong>Strike cost:</strong> Exercise cost is $1.00 &times; shares. Net value = (shares granted &divide; total shares &times; exit valuation) &minus; strike cost.<br>
    &bull; This is not financial or tax advice. AMT, capital gains, and liquidity preferences are not modeled.
  </div>


</div>

<script>
  // =====================================================
  // CONSTANTS
  // =====================================================
  const PRE_B_SHARES = 34_000_000;
  const SERIES_B_RAISE = 200_000_000;
  const PRE_MONEY = 1_000_000_000;
  const POST_MONEY = PRE_MONEY + SERIES_B_RAISE;
  const STRIKE_PRICE = 1.00;

  // Series B: new shares = pre-B shares * (raise / pre-money)
  const SERIES_B_NEW_SHARES = PRE_B_SHARES * (SERIES_B_RAISE / PRE_MONEY);
  const POST_B_TOTAL_SHARES = PRE_B_SHARES + SERIES_B_NEW_SHARES;
  const IMPLIED_PPS = POST_MONEY / POST_B_TOTAL_SHARES;

  // =====================================================
  // CARTA DILUTION BENCHMARKS (Deep Tech, Priced Rounds)
  // Source: 919 rounds from US deep tech startups on Carta
  // =====================================================
  // { low: 25th pct, mid: 50th pct, high: 75th pct }
  const CARTA_DILUTION = {
    seriesB: { low: 0.100, mid: 0.160, high: 0.243 },
    seriesC: { low: 0.085, mid: 0.140, high: 0.210 },
    // Series D+ &mdash; extrapolated from Carta priced round trends
    // Later rounds typically have lower dilution as companies are larger
    seriesD: { low: 0.060, mid: 0.100, high: 0.160 },
  };

  // =====================================================
  // HELPERS
  // =====================================================
  function fmt(n, decimals = 0) {
    return n.toLocaleString('en-US', { minimumFractionDigits: decimals, maximumFractionDigits: decimals });
  }
  function fmtDollar(n, decimals = 0) {
    const abs = Math.abs(n);
    const sign = n < 0 ? '-' : '';
    if (abs >= 1e9) return sign + '$' + (abs / 1e9).toFixed(1) + 'B';
    if (abs >= 1e6) return sign + '$' + (abs / 1e6).toFixed(1) + 'M';
    if (abs >= 1e3) return sign + '$' + (abs / 1e3).toFixed(0) + 'K';
    return sign + '$' + fmt(abs, decimals);
  }
  function fmtPct(n, decimals = 4) {
    return (n * 100).toFixed(decimals) + '%';
  }
  function fmtMoney(n) {
    if (n < 0) return '-$' + fmt(Math.abs(n));
    return '$' + fmt(n);
  }

  // =====================================================
  // DOM REFS
  // =====================================================
  const SHARES_GRANTED = 110_000;
  const elSeriesBDilution = document.getElementById('seriesBDilution');
  const elFutureRounds = document.getElementById('futureRounds');
  const elSeverity = document.getElementById('severitySelect');

  // =====================================================
  // CORE COMPUTATION
  // =====================================================
  function getDilutionSchedule() {
    const seriesBDilution = parseFloat(elSeriesBDilution.value);
    const futureRounds = parseInt(elFutureRounds.value);
    const severity = elSeverity.value;

    // Build round-by-round schedule
    // Each entry: { name, dilutionPct, newSharesIssued, totalSharesAfter }
    const schedule = [];

    // Series B &mdash; uses the dropdown (could be implied or Carta)
    const seriesBNewShares = (PRE_B_SHARES / (1 - seriesBDilution)) - PRE_B_SHARES;
    let totalShares = PRE_B_SHARES + seriesBNewShares;
    schedule.push({
      name: 'Series B',
      dilutionPct: seriesBDilution,
      newSharesIssued: seriesBNewShares,
      totalSharesAfter: totalShares,
    });

    // Future rounds use Carta benchmarks based on severity toggle
    const roundDefs = [
      { name: 'Series C', data: CARTA_DILUTION.seriesC },
      { name: 'Series D', data: CARTA_DILUTION.seriesD },
    ];

    for (let i = 0; i < futureRounds && i < roundDefs.length; i++) {
      const dilPct = roundDefs[i].data[severity];
      const newShares = (totalShares / (1 - dilPct)) - totalShares;
      totalShares += newShares;
      schedule.push({
        name: roundDefs[i].name,
        dilutionPct: dilPct,
        newSharesIssued: newShares,
        totalSharesAfter: totalShares,
      });
    }

    return schedule;
  }

  function compute() {
    const sharesGranted = SHARES_GRANTED;
    const schedule = getDilutionSchedule();

    // --- Fundamentals ---
    document.getElementById('seriesBShares').textContent = fmt(Math.round(SERIES_B_NEW_SHARES));
    document.getElementById('postBTotalShares').textContent = fmt(Math.round(POST_B_TOTAL_SHARES));
    document.getElementById('impliedPPS').textContent = '$' + IMPLIED_PPS.toFixed(2);

    // --- Ownership at various stages ---
    const ownershipAtGrant = sharesGranted / PRE_B_SHARES;
    document.getElementById('ownershipAtGrant').textContent = fmtPct(ownershipAtGrant);

    const totalSharesAfterB = schedule[0].totalSharesAfter;
    const ownershipPostB = sharesGranted / totalSharesAfterB;
    document.getElementById('ownershipPostB').textContent = fmtPct(ownershipPostB);

    const finalTotalShares = schedule[schedule.length - 1].totalSharesAfter;
    const ownershipFinal = sharesGranted / finalTotalShares;
    document.getElementById('ownershipFullyDiluted').textContent = fmtPct(ownershipFinal);

    // Paper value
    const paperValue = sharesGranted * IMPLIED_PPS - sharesGranted * STRIKE_PRICE;
    document.getElementById('paperValue').textContent = fmtMoney(Math.round(paperValue));

    // Cumulative dilution from grant
    const cumDilution = 1 - (ownershipFinal / ownershipAtGrant);
    document.getElementById('cumDilution').textContent = fmtPct(cumDilution, 1);

    // --- KPIs ---
    document.getElementById('kpiShares').textContent = fmt(sharesGranted);

    document.getElementById('kpiTotalShares').textContent = fmt(Math.round(finalTotalShares));
    document.getElementById('kpiTotalSharesSub').textContent = 'from ' + fmt(PRE_B_SHARES) + ' pre-B';

    document.getElementById('kpiOwnership').textContent = fmtPct(ownershipFinal);
    document.getElementById('kpiOwnershipSub').textContent = fmtPct(ownershipAtGrant) + ' at grant';

    // --- Waterfall ---
    buildWaterfall(sharesGranted, schedule);

    // --- Sensitivity Table ---
    buildSensitivityTable(sharesGranted, finalTotalShares);

    // --- 4-Year Vest KPIs (at $5B base case) ---
    const baseExitEV = 5e9;
    const basePPS = baseExitEV / finalTotalShares;
    const baseNetEquity = sharesGranted * basePPS - sharesGranted * STRIKE_PRICE;
    const baseTotal4yr = CASH_COMP * HORIZON + baseNetEquity;
    document.getElementById('kpiTotal4yr').textContent = fmtDollar(baseTotal4yr);
    document.getElementById('kpiTotal4yrSub').textContent = fmtDollar(CASH_COMP * HORIZON) + ' cash + ' + fmtDollar(baseNetEquity) + ' equity';
    document.getElementById('kpiEquity4yr').textContent = fmtDollar(baseNetEquity);
    document.getElementById('kpiEquity4yrSub').textContent = 'Net of $' + fmt(sharesGranted * STRIKE_PRICE) + ' strike cost';

    // --- Equity Chart ---
    buildEquityChart();
  }

  // =====================================================
  // WATERFALL
  // =====================================================
  function buildWaterfall(sharesGranted, schedule) {
    const container = document.getElementById('waterfall');
    container.innerHTML = '';

    // Build stages: At Grant, then after each round
    const stages = [];
    stages.push({
      label: 'At Grant',
      ownership: sharesGranted / PRE_B_SHARES,
      totalShares: PRE_B_SHARES,
      dilution: 0,
    });

    schedule.forEach(round => {
      stages.push({
        label: 'Post ' + round.name,
        ownership: sharesGranted / round.totalSharesAfter,
        totalShares: round.totalSharesAfter,
        dilution: round.dilutionPct,
      });
    });

    const maxPct = stages[0].ownership;

    // Distinct color per round stage
    const stageColors = [
      { bar: '#6c5ce7', tip: '#6c5ce7', lost: 'rgba(108,92,231,0.15)', lostBorder: 'rgba(108,92,231,0.4)' },   // At Grant (purple)
      { bar: '#00b894', tip: '#00b894', lost: 'rgba(0,184,148,0.15)', lostBorder: 'rgba(0,184,148,0.4)' },       // Series B (teal)
      { bar: '#fdcb6e', tip: '#fdcb6e', lost: 'rgba(253,203,110,0.15)', lostBorder: 'rgba(253,203,110,0.4)' },   // Series C (amber)
      { bar: '#e17055', tip: '#e17055', lost: 'rgba(225,112,85,0.15)', lostBorder: 'rgba(225,112,85,0.4)' },       // Series D (coral)
    ];

    stages.forEach((s, i) => {
      const group = document.createElement('div');
      group.className = 'waterfall-bar-group';

      const remainPct = (s.ownership / maxPct) * 100;
      const lostPct = 100 - remainPct;
      const isBaseline = i === 0;
      const sc = stageColors[i] || stageColors[stageColors.length - 1];

      group.innerHTML = `
        <span class="tip" style="color:${sc.tip}">${fmtPct(s.ownership, 4)}</span>
        <div style="width:100%;height:100%;display:flex;flex-direction:column;justify-content:flex-end;">
          ${!isBaseline ? `<div style="flex:0 0 ${lostPct}%;background:${sc.lost};border-radius:4px 4px 0 0;border-bottom:2px dashed ${sc.lostBorder};"></div>` : ''}
          <div class="waterfall-bar" style="height:${remainPct}%;background:${sc.bar};"></div>
        </div>
        <span class="bar-label">${s.label}</span>
        ${s.dilution > 0 ? `<span class="dilution-label" style="color:${sc.tip};">-${fmtPct(s.dilution, 1)}</span>` : '<span class="dilution-label" style="color:var(--green);">Baseline</span>'}
      `;
      container.appendChild(group);
    });

    const totalDilution = 1 - (stages[stages.length - 1].ownership / stages[0].ownership);
    document.getElementById('waterfallTotal').textContent = 'Cumulative dilution: ' + fmtPct(totalDilution, 1);

    // Detail rows
    const detail = document.getElementById('dilutionDetail');
    let detailHtml = '';
    schedule.forEach((round, i) => {
      const pctWidth = (round.dilutionPct / 0.30) * 100; // normalize to 30% max
      const color = round.dilutionPct > 0.20 ? 'var(--red)' : round.dilutionPct > 0.12 ? 'var(--yellow)' : 'var(--green)';
      detailHtml += `
        <span class="round-name">${round.name}</span>
        <div class="bar-track"><div class="bar-fill" style="width:${Math.min(pctWidth, 100)}%;background:${color};"></div></div>
        <span style="color:${color};font-weight:600;">${fmtPct(round.dilutionPct, 1)}</span>
        <span style="color:var(--text-muted);">+${fmt(Math.round(round.newSharesIssued))} shares &rarr; ${fmt(Math.round(round.totalSharesAfter))} total</span>
      `;
    });
    detail.innerHTML = detailHtml;
  }

  // =====================================================
  // SENSITIVITY TABLE &mdash; POST-DILUTION NET VALUE
  // =====================================================
  function buildSensitivityTable(sharesGranted, finalTotalShares) {
    const table = document.getElementById('sensitivityTable');

    const exitValues = [1e9, 2e9, 3e9, 5e9, 7e9, 10e9, 15e9, 20e9];

    let html = '<thead><tr><th style="text-align:left;border-right:2px solid var(--border);">Exit Valuation</th>';
    exitValues.forEach(ev => {
      const is5B = ev === 5e9;
      html += `<th${is5B ? ' style="color:var(--accent-light);"' : ''}>${fmtDollar(ev)}${is5B ? ' (5&times;)' : ''}</th>`;
    });
    html += '</tr></thead><tbody>';

    // 4-year net equity row
    html += '<tr><td>4-Year Net Equity</td>';
    exitValues.forEach(ev => {
      const pps = ev / finalTotalShares;
      const net = sharesGranted * pps - sharesGranted * STRIKE_PRICE;
      const is5B = ev === 5e9;
      const cls = is5B ? 'highlight-cell' : '';
      const colorCls = net < 0 ? 'negative' : '';
      html += `<td class="${cls} ${colorCls}">${fmtDollar(net)}</td>`;
    });
    html += '</tr>';

    // Total 4-year comp row (cash + equity)
    html += '<tr><td>4-Year Total Comp</td>';
    exitValues.forEach(ev => {
      const pps = ev / finalTotalShares;
      const net = sharesGranted * pps - sharesGranted * STRIKE_PRICE;
      const total = CASH_COMP * HORIZON + net;
      const is5B = ev === 5e9;
      const cls = is5B ? 'highlight-cell' : '';
      html += `<td class="${cls}">${fmtDollar(total)}</td>`;
    });
    html += '</tr>';

    html += '</tbody>';
    table.innerHTML = html;
  }

  const CASH_COMP = 300_000;     // annual cash compensation
  const HORIZON = 4;             // years

  // =====================================================
  // EQUITY VALUE CHART (interactive)
  // =====================================================
  // Store chart state for mouse interaction
  let chartState = null;

  function buildEquityChart() {
    const canvas = document.getElementById('equityChart');
    const ctx = canvas.getContext('2d');
    const dpr = window.devicePixelRatio || 1;

    // Hi-DPI scaling
    const rect = canvas.getBoundingClientRect();
    canvas.width = rect.width * dpr;
    canvas.height = rect.height * dpr;
    ctx.scale(dpr, dpr);
    const W = rect.width;
    const H = rect.height;

    // Chart config
    const pad = { top: 20, right: 20, bottom: 40, left: 70 };
    const cW = W - pad.left - pad.right;
    const cH = H - pad.top - pad.bottom;

    const exitValues = [1e9, 2e9, 3e9, 5e9, 7e9, 10e9, 15e9, 20e9];

    const seriesBDilution = parseFloat(elSeriesBDilution.value);
    const futureRounds = parseInt(elFutureRounds.value);

    // Calculate total shares for each dilution severity
    function calcTotalShares(sev) {
      let total = PRE_B_SHARES / (1 - seriesBDilution);
      const rounds = [CARTA_DILUTION.seriesC, CARTA_DILUTION.seriesD];
      for (let i = 0; i < futureRounds && i < rounds.length; i++) {
        total = total / (1 - rounds[i][sev]);
      }
      return total;
    }

    const scenarios = [
      { key: 'low', color: '#00b894', label: 'Low' },
      { key: 'mid', color: '#a29bfe', label: 'Mid' },
      { key: 'high', color: '#e17055', label: 'High' },
    ];

    // Compute data points for each scenario
    const allData = scenarios.map(s => {
      const totalShares = calcTotalShares(s.key);
      return exitValues.map(ev => {
        const net = SHARES_GRANTED * (ev / totalShares) - SHARES_GRANTED * STRIKE_PRICE;
        return net;
      });
    });

    // Y-axis range
    const allVals = allData.flat();
    const yMin = Math.min(0, Math.min(...allVals));
    const yMax = Math.max(...allVals) * 1.1;

    function xPos(i) { return pad.left + (i / (exitValues.length - 1)) * cW; }
    function yPos(v) { return pad.top + cH - ((v - yMin) / (yMax - yMin)) * cH; }

    // Store chart state for hover interaction
    chartState = { canvas, ctx, dpr, W, H, pad, cW, cH, exitValues, scenarios, allData, yMin, yMax, xPos, yPos, hoveredIdx: -1 };

    drawChart();
  }

  function drawChart(hoveredIdx) {
    if (!chartState) return;
    const { ctx, W, H, pad, cW, cH, exitValues, scenarios, allData, yMin, yMax, xPos, yPos } = chartState;

    ctx.clearRect(0, 0, W, H);

    // Grid lines
    ctx.strokeStyle = '#2e3142';
    ctx.lineWidth = 0.5;
    const yTicks = 6;
    for (let i = 0; i <= yTicks; i++) {
      const v = yMin + (yMax - yMin) * (i / yTicks);
      const y = yPos(v);
      ctx.beginPath();
      ctx.moveTo(pad.left, y);
      ctx.lineTo(W - pad.right, y);
      ctx.stroke();

      // Y labels
      ctx.fillStyle = '#8b8fa3';
      ctx.font = '11px -apple-system, BlinkMacSystemFont, sans-serif';
      ctx.textAlign = 'right';
      ctx.textBaseline = 'middle';
      ctx.fillText(fmtDollar(v), pad.left - 8, y);
    }

    // X labels
    ctx.textAlign = 'center';
    ctx.textBaseline = 'top';
    exitValues.forEach((ev, i) => {
      const x = xPos(i);
      ctx.fillStyle = '#8b8fa3';
      ctx.font = '11px -apple-system, BlinkMacSystemFont, sans-serif';
      ctx.fillText(fmtDollar(ev), x, pad.top + cH + 10);

      // Vertical grid
      ctx.strokeStyle = '#2e3142';
      ctx.lineWidth = 0.5;
      ctx.beginPath();
      ctx.moveTo(x, pad.top);
      ctx.lineTo(x, pad.top + cH);
      ctx.stroke();
    });

    // Zero line
    if (yMin < 0) {
      ctx.strokeStyle = '#4a4d5e';
      ctx.lineWidth = 1;
      ctx.setLineDash([4, 4]);
      ctx.beginPath();
      ctx.moveTo(pad.left, yPos(0));
      ctx.lineTo(W - pad.right, yPos(0));
      ctx.stroke();
      ctx.setLineDash([]);
    }

    // Draw lines with area fill
    allData.forEach((data, si) => {
      const color = scenarios[si].color;

      // Area fill
      ctx.beginPath();
      ctx.moveTo(xPos(0), yPos(0));
      data.forEach((v, i) => ctx.lineTo(xPos(i), yPos(v)));
      ctx.lineTo(xPos(data.length - 1), yPos(0));
      ctx.closePath();
      ctx.fillStyle = color + '12';
      ctx.fill();

      // Line
      ctx.beginPath();
      data.forEach((v, i) => {
        if (i === 0) ctx.moveTo(xPos(i), yPos(v));
        else ctx.lineTo(xPos(i), yPos(v));
      });
      ctx.strokeStyle = color;
      ctx.lineWidth = 2.5;
      ctx.stroke();

      // Dots
      data.forEach((v, i) => {
        const isHovered = (hoveredIdx >= 0 && hoveredIdx === i);
        const r = (si === 1 && isHovered) ? 6 : 3;
        ctx.beginPath();
        ctx.arc(xPos(i), yPos(v), r, 0, Math.PI * 2);
        ctx.fillStyle = color;
        ctx.fill();
        if (si === 1 && isHovered) {
          ctx.strokeStyle = '#fff';
          ctx.lineWidth = 2;
          ctx.stroke();
        }
      });
    });

    // Highlight $5B base case exit
    const selectedExit = 5e9;
    const selectedIdx = exitValues.indexOf(selectedExit);
    if (selectedIdx >= 0) {
      const x = xPos(selectedIdx);
      ctx.strokeStyle = '#a29bfe';
      ctx.lineWidth = 1;
      ctx.setLineDash([3, 3]);
      ctx.beginPath();
      ctx.moveTo(x, pad.top);
      ctx.lineTo(x, pad.top + cH);
      ctx.stroke();
      ctx.setLineDash([]);
    }

    // Draw hover crosshair and tooltip for mid line
    if (hoveredIdx >= 0 && hoveredIdx < exitValues.length) {
      const x = xPos(hoveredIdx);

      // Vertical hover line
      ctx.strokeStyle = 'rgba(162,155,254,0.5)';
      ctx.lineWidth = 1;
      ctx.setLineDash([2, 2]);
      ctx.beginPath();
      ctx.moveTo(x, pad.top);
      ctx.lineTo(x, pad.top + cH);
      ctx.stroke();
      ctx.setLineDash([]);

      // Tooltip showing all 3 scenario values
      const midVal = allData[1][hoveredIdx];
      const lowVal = allData[0][hoveredIdx];
      const highVal = allData[2][hoveredIdx];
      const exitLabel = fmtDollar(exitValues[hoveredIdx]);

      // Format to $X.XM
      function fmtM(v) {
        const sign = v < 0 ? '-' : '';
        return sign + '$' + (Math.abs(v) / 1e6).toFixed(1) + 'M';
      }

      const lines = [
        exitLabel + ' Exit',
        '\u25CF Low:  ' + fmtM(lowVal),
        '\u25CF Mid:  ' + fmtM(midVal),
        '\u25CF High: ' + fmtM(highVal),
      ];

      ctx.font = 'bold 12px -apple-system, BlinkMacSystemFont, sans-serif';
      const lineH = 18;
      const tooltipPad = 10;
      const maxTextW = Math.max(...lines.map(l => ctx.measureText(l).width));
      const tooltipW = maxTextW + tooltipPad * 2;
      const tooltipH = lines.length * lineH + tooltipPad * 2;

      // Position: prefer right of point, flip if near edge
      let tx = x + 12;
      if (tx + tooltipW > W - pad.right) tx = x - tooltipW - 12;
      let ty = yPos(midVal) - tooltipH / 2;
      ty = Math.max(pad.top, Math.min(ty, pad.top + cH - tooltipH));

      // Background
      ctx.fillStyle = 'rgba(26,29,39,0.95)';
      ctx.strokeStyle = 'rgba(162,155,254,0.6)';
      ctx.lineWidth = 1;
      ctx.beginPath();
      ctx.roundRect(tx, ty, tooltipW, tooltipH, 6);
      ctx.fill();
      ctx.stroke();

      // Text
      const lineColors = ['#e2e4eb', '#00b894', '#a29bfe', '#e17055'];
      lines.forEach((line, li) => {
        ctx.fillStyle = lineColors[li];
        ctx.font = li === 0 ? 'bold 12px -apple-system, BlinkMacSystemFont, sans-serif' : '12px -apple-system, BlinkMacSystemFont, sans-serif';
        ctx.textAlign = 'left';
        ctx.textBaseline = 'top';
        ctx.fillText(line, tx + tooltipPad, ty + tooltipPad + li * lineH);
      });
    }
  }

  // Mouse interaction for chart
  (function() {
    const canvas = document.getElementById('equityChart');
    canvas.style.cursor = 'crosshair';

    canvas.addEventListener('mousemove', function(e) {
      if (!chartState) return;
      const rect = canvas.getBoundingClientRect();
      const mx = e.clientX - rect.left;
      const { pad, cW, exitValues, xPos } = chartState;

      // Find nearest data point index on x-axis
      let nearest = -1;
      let minDist = Infinity;
      for (let i = 0; i < exitValues.length; i++) {
        const dist = Math.abs(mx - xPos(i));
        if (dist < minDist) { minDist = dist; nearest = i; }
      }
      // Only show tooltip if within 30px of a data point
      if (minDist > 30) nearest = -1;

      if (nearest !== chartState.hoveredIdx) {
        chartState.hoveredIdx = nearest;
        drawChart(nearest);
      }
    });

    canvas.addEventListener('mouseleave', function() {
      if (!chartState) return;
      chartState.hoveredIdx = -1;
      drawChart(-1);
    });
  })();

  // =====================================================
  // EVENT LISTENERS
  // =====================================================
  [elSeriesBDilution, elFutureRounds, elSeverity].forEach(el => {
    el.addEventListener('change', compute);
    el.addEventListener('input', compute);
  });

  // Init
  compute();
</script>
</body>
</html>
